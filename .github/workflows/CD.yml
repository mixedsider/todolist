name: CD - Deploy to Remote Server (Dependent on CI)

on:
  workflow_run:
    # 1. CI 워크플로우의 이름으로 설정 (ci.yml 파일의 name 필드와 일치해야 함)
    workflows: ["CI - Test & Report"]
    # 2. CI 워크플로우가 완료(completed)되었을 때만 트리거
    types: [completed]
    # 3. main 브랜치에 대해서만 배포
    branches: [main]

jobs:
  # CD Job은 CI Job의 성공 여부에 따라 조건부 실행됩니다.
  deploy:
    # CI 워크플로우의 결론(conclusion)이 'success'일 때만 실행
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1. 원격 CI 워크플로우의 커밋으로 체크아웃 (CI가 실행된 시점의 코드를 가져옴)
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # 2. Artifacts 다운로드 (CI에서 업로드된 파일 가져오기)
      # 다운로드할 워크플로우 ID를 참조해야 합니다.
      - name: Get CI Artifacts ID
        uses: actions/github-script@v7
        id: get-artifact
        with:
          script: |
            // CI 워크플로우 실행 ID를 기반으로 아티팩트 ID를 찾습니다.
            const runId = context.payload.workflow_run.id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            // 다운로드할 아티팩트 목록을 찾습니다.
            core.setOutput('run_id', runId);
            core.setOutput('backend_id', artifacts.data.artifacts.find(a => a.name === 'deploy-backend-jar').id);
            core.setOutput('frontend_id', artifacts.data.artifacts.find(a => a.name === 'deploy-frontend-dist').id);

      - name: Download Backend JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-backend-jar
          path: ./artifacts/backend/

      - name: Download Frontend DIST Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-frontend-dist
          path: ./artifacts/frontend/

      # --- (이하 SSH 설정 및 배포 로직은 이전과 동일) ---
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- 파일 전송 및 서비스 재시작 ---
      - name: Transfer Backend JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "artifacts/backend/*.jar"
          target: "~/backend"
          strip_components: 2

      - name: Transfer Frontend DIST to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "artifacts/frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      - name: Stop, Rename, and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            FRONTEND_PATH="/home/${{ secrets.DEPLOY_USER }}/frontend"
            JAR_NAME="backend.jar"
            
            mkdir -p ${DEPLOY_PATH}
            mkdir -p ${FRONTEND_PATH}
            
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"
              kill -9 $CURRENT_PID
              sleep 5
            else
              echo "No running process found for $JAR_NAME."
            fi
            
            NEW_JAR=$(find ${DEPLOY_PATH} -maxdepth 1 -name "*.jar" -print -quit)
            
            if [ -f "$NEW_JAR" ]; then
                mv $NEW_JAR ${DEPLOY_PATH}/${JAR_NAME}
                echo "Renamed $NEW_JAR to $JAR_NAME"
            else
                echo "Error: New JAR file not found!"
                exit 1
            fi
            
            echo "Starting application: ${DEPLOY_PATH}/${JAR_NAME}"
            nohup java -jar ${DEPLOY_PATH}/${JAR_NAME} > ${DEPLOY_PATH}/app.log 2>&1 &
            
            echo "Deployment and restart complete."