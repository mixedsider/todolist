name: CD - Build and Deploy to Remote Server (Monorepo)

# main ë¸Œëžœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production # ë°°í¬ í™˜ê²½ ì§€ì • (ì„ íƒ ì‚¬í•­)

    steps:
      # 1. ìµœì‹  ì»¤ë°‹ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # 2. ë°±ì—”ë“œ(Java/Spring Boot) ë¹Œë“œ ì„¤ì • (Working Directory: backend)
      # ==========================================================

      # Gradle ë¹Œë“œ ì†ë„ í–¥ìƒì„ ìœ„í•œ ìºì‹œ ì„¤ì •
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/build.gradle*', 'backend/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Java 17 ì„¤ì • (ë²„ì „ í™•ì¸ í•„ìš”)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ê¶Œí•œ ì„¤ì • (backend ë””ë ‰í† ë¦¬ ë‚´ì˜ gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬)
      - name: Grant Execute Permission for gradlew
        run: chmod +x ./backend/gradlew

      # ë°±ì—”ë“œ ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
      - name: Build Backend JAR
        working-directory: ./backend # ðŸš¨ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ backendë¡œ ì„¤ì •
        run: ./gradlew bootJar

      # ==========================================================
      # 3. í”„ë¡ íŠ¸ì—”ë“œ(Node.js) ë¹Œë“œ ì„¤ì • (Working Directory: frontend)
      # ==========================================================

      # Node.js 20 ì„¤ì • (ë²„ì „ í™•ì¸ í•„ìš”)
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json # frontendì˜ lock íŒŒì¼ ì°¸ì¡°

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Frontend Dependencies
        working-directory: ./frontend # ðŸš¨ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ frontendë¡œ ì„¤ì •
        run: npm install

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì •ì  íŒŒì¼ ìƒì„±)
      - name: Build Frontend DIST
        working-directory: ./frontend # ðŸš¨ ìž‘ì—… ë””ë ‰í† ë¦¬ë¥¼ frontendë¡œ ì„¤ì •
        run: npm run build # package.jsonì— ì •ì˜ëœ build ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

      # ==========================================================
      # 4. ë°°í¬ (SSH ì—°ê²° ë° íŒŒì¼ ì „ì†¡)
      # ==========================================================

      # SSH ì—ì´ì „íŠ¸ ì„¤ì • ë° í‚¤ ë¡œë“œ
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ë°±ì—”ë“œ JAR íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      - name: Transfer Backend JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ðŸš¨ ì „ì²´ ê²½ë¡œ ì§€ì •: todolist/backend/build/libs/*.jar
          source: "backend/build/libs/*.jar"
          target: "~/backend"
          # 'backend/build/libs/' ê²½ë¡œë¥¼ ë²—ê²¨ë‚´ê¸° ìœ„í•´ 3ìœ¼ë¡œ ì„¤ì •
          strip_components: 3

      # í”„ë¡ íŠ¸ì—”ë“œ DIST íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      - name: Transfer Frontend DIST to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ðŸš¨ ì „ì²´ ê²½ë¡œ ì§€ì •: todolist/frontend/dist/*
          source: "frontend/dist/*"
          target: "~/frontend"
          # 'frontend/dist/' ê²½ë¡œë¥¼ ë²—ê²¨ë‚´ê¸° ìœ„í•´ 2ë¡œ ì„¤ì • (distê°€ ë°”ë¡œ ë¹Œë“œ ê²°ê³¼ í´ë”ì¼ ê²½ìš°)
          strip_components: 2

      # ì›ê²© ì„œë²„ì—ì„œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: Stop, Rename, and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          script: |
            # 1. í™˜ê²½ ë³€ìˆ˜ ì •ì˜
            DB_URL="${{ vars.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DB_PORT="${{ vars.DB_PORT }}"

            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            JAR_NAME="backend.jar"

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            fi

            # ----------------------------------------------------
            # 2. ìƒˆë¡œìš´ JAR íŒŒì¼ êµì²´ ë° ìž¬ì‹¤í–‰
            # ----------------------------------------------------

            # ìƒˆë¡œ ì „ì†¡ëœ JAR íŒŒì¼ ì°¾ê¸° (ê°€ìž¥ ìµœì‹  íŒŒì¼)
            LATEST_JAR=$(ls -t ${DEPLOY_PATH}/*.jar | grep -v "${JAR_NAME}" | head -n 1)
            
            # ê¸°ì¡´ JAR ì‚­ì œ ë° ìƒˆë¡œìš´ JARë¡œ êµì²´
            if [ -f "$LATEST_JAR" ]; then
              echo "Found new JAR: $LATEST_JAR"
              rm -f ${DEPLOY_PATH}/${JAR_NAME} # ê¸°ì¡´ JAR ì‚­ì œ
              mv $LATEST_JAR ${DEPLOY_PATH}/${JAR_NAME} # ìƒˆ JARë¡œ êµì²´
              echo "New application file deployed: ${DEPLOY_PATH}/${JAR_NAME}"
            fi

            # -D ì‹œìŠ¤í…œ ì†ì„± ì „ë‹¬ ë°©ì‹ìœ¼ë¡œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            echo "Starting application with properties..."
            nohup java -jar \
              -DB_URL=$DB_URL \
              -DB_USERNAME=$DB_USER \
              -DB_PASSWORD=$DB_PASS \
              -DB_PORT=$DB_PORT \
              ${DEPLOY_PATH}/${JAR_NAME} \
              > ${DEPLOY_PATH}/app.log 2>&1 &
            
            echo "Deployment and restart complete."