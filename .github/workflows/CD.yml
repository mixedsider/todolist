name: CD - Build and Deploy

# main 브랜치에 코드가 푸시될 때 워크플로우 실행
on:
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: DEPLOY # 배포 환경 지정 (선택 사항)

    steps:
      # 1. 최신 커밋 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # 2. 백엔드(Java/Spring Boot) 빌드 설정 (Working Directory: backend)
      # ==========================================================
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/build.gradle*', 'backend/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant Execute Permission for gradlew
        run: chmod +x ./backend/gradlew

      # 백엔드 빌드 실행
      - name: Build Backend JAR
        working-directory: ./backend
        run: ./gradlew bootJar

      # ==========================================================
      # 3. 프론트엔드(Node.js) 빌드 설정 (Working Directory: frontend)
      # ==========================================================
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      # 프론트엔드 빌드 실행
      - name: Build Frontend DIST
        working-directory: ./frontend
        run: npm run build

      # ==========================================================
      # 4. 배포 (SSH 연결 및 파일 전송)
      # ==========================================================

      # SSH 에이전트 설정 및 키 로드
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-1. Frontend DIST 파일 서버로 직접 전송 (BASTION_HOST = Frontend Deploy Target)
      # ----------------------------------------------------------
      - name: Transfer Frontend DIST to Bastion/Frontend Server
        uses: appleboy/scp-action@v0.1.7
        with:
          # 프론트엔드는 Bastion 호스트에 직접 배포
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.BASTION_HOST_PORT }}
          source: "frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      # ----------------------------------------------------------
      # 4-2. Backend JAR 파일 Target Server로 Proxy를 통해 전송
      # ----------------------------------------------------------
      - name: Transfer Backend JAR to Target Server (via Bastion)
        uses: appleboy/scp-action@v0.1.7
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 💡 [수정] 동적으로 추출한 파일명으로 정확한 파일만 전송합니다.
          source: "./backend/build/libs/${{ steps.set_jar_filename.outputs.jar_name }}"
          # 💡 [수정] Target 서버에도 고유한 파일명 그대로 저장합니다.
          target: "~/backend/${{ steps.set_jar_filename.outputs.jar_name }}"

          # Bastion Host 설정 (ProxyCommand 역할)
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-3. Target Server에서 서비스 재시작 (Proxy를 통해 SSH 명령 실행)
      # ----------------------------------------------------------
      - name: Stop, Rename, and Restart Backend Application (via Bastion)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # Bastion Host 설정
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            # 1. 환경 변수 정의
            DB_URL="${{ secrets.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
            
            DEPLOY_PATH="/home/${DEPLOY_USER}/backend"
            
            # 💡 [수정] 실행할 JAR 파일 이름을 이전 단계에서 가져옵니다.
            JAR_FILE_TO_RUN="${{ steps.set_jar_filename.outputs.jar_name }}"
            FINAL_JAR_PATH="${DEPLOY_PATH}/${JAR_FILE_TO_RUN}"
            
            # 2. 기존 프로세스 종료
            # 일반적으로 애플리케이션 실행 명령어의 일부를 PID 검색 키워드로 사용합니다.
            # 이전에 실행했던 backend.jar 또는 java 키워드로 PID를 찾습니다.
            CURRENT_PID=$(ps -ef | grep java | grep "${DEPLOY_PATH}" | grep -v grep | awk '{print $2}')
            
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping old process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            else
              echo "Active Java process not found. Proceeding to deployment."
            fi
            
            # 3. 새로운 JAR 파일 실행
            if [ -f "$FINAL_JAR_PATH" ]; then
              echo "✅ 새로운 JAR 파일 ($FINAL_JAR_PATH) 실행."
              # JAR 파일에 실행 권한이 부족할 경우를 대비하여 권한을 명시적으로 부여합니다.
              chmod 744 "$FINAL_JAR_PATH"
            
              # nohup을 사용하여 백그라운드에서 실행하고, 환경 변수를 인라인으로 전달
              nohup java -jar \
                -Dspring.datasource.url=$DB_URL \
                -Dspring.datasource.username=$DB_USER \
                -Dspring.datasource.password=$DB_PASS \
                "$FINAL_JAR_PATH" \
                > ${DEPLOY_PATH}/app.log 2>&1 &
            else
              echo "❌ 실행할 새로운 JAR 파일 ($FINAL_JAR_PATH)을 찾을 수 없습니다. 배포 실패."
              exit 1
            fi
            
            # 4. SSH 세션 종료
            sleep 5 # 백그라운드 프로세스 시작 대기
            echo "Deployment initiated. Disconnecting SSH session successfully."
            exit 0