name: CD - Build and Deploy to Remote Server

# main ë¸Œëžœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production # ë°°í¬ í™˜ê²½ ì§€ì • (ì„ íƒ ì‚¬í•­)

    steps:
      # 1. ìµœì‹  ì»¤ë°‹ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # Gradle ë¹Œë“œ ì†ë„ í–¥ìƒì„ ìœ„í•œ ìºì‹œ ì„¤ì • (backend í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìºì‹œ)
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Java 17 ì„¤ì • (ì‚¬ìš©í•˜ì‹œëŠ” ë²„ì „ì— ë§žê²Œ ìˆ˜ì •í•˜ì„¸ìš”)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # ê¶Œí•œ ì„¤ì • (Gradle Wrapper ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬)
      - name: Grant Execute Permission for gradlew
        run: chmod +x ./gradlew

      # ë°±ì—”ë“œ ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±). ë¹Œë“œ ê²°ê³¼ëŠ” ì¼ë°˜ì ìœ¼ë¡œ 'build/libs/'ì— ìƒì„±ë©ë‹ˆë‹¤.
      - name: Build Backend JAR
        run: ./gradlew bootJar

      # ==========================================================
      # 3. í”„ë¡ íŠ¸ì—”ë“œ(Node.js) ë¹Œë“œ ì„¤ì •
      # ==========================================================

      # Node.js 20 ì„¤ì • (ì‚¬ìš©í•˜ì‹œëŠ” ë²„ì „ì— ë§žê²Œ ìˆ˜ì •í•˜ì„¸ìš”)
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # npm ìºì‹œ ì‚¬ìš©

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Frontend Dependencies
        run: npm install

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ì •ì  íŒŒì¼ ìƒì„±). ë¹Œë“œ ê²°ê³¼ëŠ” ì¼ë°˜ì ìœ¼ë¡œ 'dist/' ë˜ëŠ” 'build/'ì— ìƒì„±ë©ë‹ˆë‹¤.
      - name: Build Frontend DIST
        run: npm run build # package.jsonì— ì •ì˜ëœ build ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰

      # ==========================================================
      # 4. ë°°í¬ (SSH ì—°ê²° ë° íŒŒì¼ ì „ì†¡)
      # ==========================================================

      # SSH ì—ì´ì „íŠ¸ ì„¤ì • ë° í‚¤ ë¡œë“œ
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ë°±ì—”ë“œ JAR íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡ (ë¹Œë“œ ê²½ë¡œë¥¼ 'build/libs/*.jar'ë¡œ ê°€ì •)
      - name: Transfer Backend JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ë¹Œë“œëœ JAR íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì •í™•ížˆ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          source: "build/libs/*.jar"
          target: "~/backend"
          # JAR íŒŒì¼ì´ í¬í•¨ëœ ë””ë ‰í† ë¦¬(libs)ë¥¼ ì œì™¸í•˜ê³ , JAR íŒŒì¼ ìžì²´ë§Œ ì „ì†¡í•©ë‹ˆë‹¤.
          strip_components: 2 # build/libs/ ë¥¼ ì œì™¸í•˜ê¸° ìœ„í•´ 2ë¡œ ì„¤ì •

      # í”„ë¡ íŠ¸ì—”ë“œ DIST íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡ (ë¹Œë“œ ê²½ë¡œë¥¼ 'dist/*'ë¡œ ê°€ì •)
      - name: Transfer Frontend DIST to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ë¹Œë“œëœ ì •ì  íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì •í™•ížˆ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          source: "dist/*"
          target: "~/frontend"
          strip_components: 1 # dist/ ë¥¼ ì œì™¸í•˜ê¸° ìœ„í•´ 1ë¡œ ì„¤ì •

      # ì›ê²© ì„œë²„ì—ì„œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: Stop, Rename, and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # ðŸš¨ ê¸°ì¡´ì— ì‚¬ìš©í•˜ì‹œë˜ ìž¬ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ðŸš¨
          script: |
            # 1. í™˜ê²½ ë³€ìˆ˜ ì •ì˜ (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
            DB_URL="${{ vars.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DB_PORT="${{ vars.DB_PORT }}"

            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            JAR_NAME="backend.jar" # ë°°í¬ ê²½ë¡œì— ìžˆëŠ” JAR íŒŒì¼ ì´ë¦„

            # (ì¤‘ëžµ: ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° íŒŒì¼ êµì²´ ë¡œì§)
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            fi

            # ----------------------------------------------------
            # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ìž¬ì‹¤í–‰ ì‹œ í™˜ê²½ ë³€ìˆ˜/ì‹œìŠ¤í…œ ì†ì„± ì „ë‹¬
            # ----------------------------------------------------

            # JAR íŒŒì¼ì˜ ì´ë¦„ì„ ìž„ì‹œë¡œ ë³€ê²½í•˜ê³ , ìƒˆë¡œ ë°›ì€ JAR íŒŒì¼ì„ JAR_NAMEìœ¼ë¡œ ë³µì‚¬
            LATEST_JAR=$(ls -t ${DEPLOY_PATH}/*.jar | head -n 1)
            if [ -f "$LATEST_JAR" ] && [ "$LATEST_JAR" != "${DEPLOY_PATH}/${JAR_NAME}" ]; then
              echo "Moving new JAR: $LATEST_JAR to ${DEPLOY_PATH}/${JAR_NAME}"
              mv $LATEST_JAR ${DEPLOY_PATH}/${JAR_NAME}
            fi
            
            # -D ì‹œìŠ¤í…œ ì†ì„± ì „ë‹¬ ë°©ì‹ìœ¼ë¡œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
            echo "Starting application with properties..."
            nohup java -jar \
              -DB_URL=$DB_URL \
              -DB_USERNAME=$DB_USER \
              -DB_PASSWORD=$DB_PASS \
              -DB_PORT=$DB_PORT \
              ${DEPLOY_PATH}/${JAR_NAME} \
              > ${DEPLOY_PATH}/app.log 2>&1 &
            
            echo "Deployment and restart complete."