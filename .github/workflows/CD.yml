name: CD - Build and Deploy

# main ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: DEPLOY # ë°°í¬ í™˜ê²½ ì§€ì • (ì„ íƒ ì‚¬í•­)

    steps:
      # 1. ìµœì‹  ì»¤ë°‹ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # 2. ë°±ì—”ë“œ(Java/Spring Boot) ë¹Œë“œ ì„¤ì • (Working Directory: backend)
      # ==========================================================
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/build.gradle*', 'backend/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant Execute Permission for gradlew
        run: chmod +x ./backend/gradlew

      # ë°±ì—”ë“œ ë¹Œë“œ ì‹¤í–‰
      - name: Build Backend JAR
        working-directory: ./backend
        run: ./gradlew bootJar

      # ==========================================================
      # 3. í”„ë¡ íŠ¸ì—”ë“œ(Node.js) ë¹Œë“œ ì„¤ì • (Working Directory: frontend)
      # ==========================================================
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹¤í–‰
      - name: Build Frontend DIST
        working-directory: ./frontend
        run: npm run build

      # ==========================================================
      # 4. ë°°í¬ (SSH ì—°ê²° ë° íŒŒì¼ ì „ì†¡)
      # ==========================================================

      # SSH ì—ì´ì „íŠ¸ ì„¤ì • ë° í‚¤ ë¡œë“œ
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-1. Frontend DIST íŒŒì¼ ì„œë²„ë¡œ ì§ì ‘ ì „ì†¡ (BASTION_HOST = Frontend Deploy Target)
      # ----------------------------------------------------------
      - name: Transfer Frontend DIST to Bastion/Frontend Server
        uses: appleboy/scp-action@v0.1.7
        with:
          # í”„ë¡ íŠ¸ì—”ë“œëŠ” Bastion í˜¸ìŠ¤íŠ¸ì— ì§ì ‘ ë°°í¬
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.BASTION_HOST_PORT }}
          source: "frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      # ----------------------------------------------------------
      # 4-2. Backend JAR íŒŒì¼ Target Serverë¡œ Proxyë¥¼ í†µí•´ ì „ì†¡
      # ----------------------------------------------------------
      - name: Transfer Backend JAR to Target Server (via Bastion)
        uses: appleboy/scp-action@v0.1.7
        with:
          # Target Server ì ‘ì† ì •ë³´ (ë‚´ë¶€ IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ğŸ’¡ [ìˆ˜ì •] ë™ì ìœ¼ë¡œ ì¶”ì¶œí•œ íŒŒì¼ëª…ìœ¼ë¡œ ì •í™•í•œ íŒŒì¼ë§Œ ì „ì†¡í•©ë‹ˆë‹¤.
          source: "./backend/build/libs/*.jar"
          # ğŸ’¡ [ìˆ˜ì •] Target ì„œë²„ì—ë„ ê³ ìœ í•œ íŒŒì¼ëª… ê·¸ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
          target: "~/backend/backend-${{ github.sha }}.jar"

          # Bastion Host ì„¤ì • (ProxyCommand ì—­í• )
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-3. Target Serverì—ì„œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (Proxyë¥¼ í†µí•´ SSH ëª…ë ¹ ì‹¤í–‰)
      # ----------------------------------------------------------
      - name: Stop, Rename, and Restart Backend Application (via Bastion)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Target Server ì ‘ì† ì •ë³´ (ë‚´ë¶€ IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # Bastion Host ì„¤ì •
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            # 1. í™˜ê²½ ë³€ìˆ˜ ì •ì˜
            DB_URL="${{ secrets.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
            
            DEPLOY_PATH="/home/${DEPLOY_USER}/backend"
            
            # ğŸ’¡ [ìˆ˜ì •] ì‹¤í–‰í•  JAR íŒŒì¼ ì´ë¦„ì„ ì´ì „ ë‹¨ê³„ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            JAR_FILE_TO_RUN="backend-${{ github.sha }}.jar"
            FINAL_JAR_PATH="${DEPLOY_PATH}/${JAR_FILE_TO_RUN}"
            
            # 2. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            # ë°°í¬ ê²½ë¡œì˜ ëª¨ë“  Java í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
            CURRENT_PID=$(ps -ef | grep java | grep "${DEPLOY_PATH}" | grep -v grep | awk '{print $2}')

            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping old process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            else
              echo "Active Java process not found. Proceeding to deployment."
            fi

            # 3. ìƒˆë¡œìš´ JAR íŒŒì¼ ì‹¤í–‰
            if [ -f "$FINAL_JAR_PATH" ]; then
              echo "âœ… ìƒˆë¡œìš´ JAR íŒŒì¼ ($FINAL_JAR_PATH) ì‹¤í–‰."
              # ê¶Œí•œ ë¶€ì—¬ (í˜¹ì‹œ ëª¨ë¥¼ ì‹¤í–‰ ê¶Œí•œ ë¬¸ì œ ë°©ì§€)
              chmod 744 "$FINAL_JAR_PATH"

              # nohupì„ ì‚¬ìš©í•˜ì—¬ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
              nohup java -jar \
                -Dspring.datasource.url=$DB_URL \
                -Dspring.datasource.username=$DB_USER \
                -Dspring.datasource.password=$DB_PASS \
                "$FINAL_JAR_PATH" \
                > ${DEPLOY_PATH}/app.log 2>&1 &
            else
              echo "âŒ ì‹¤í–‰í•  ìƒˆë¡œìš´ JAR íŒŒì¼ ($FINAL_JAR_PATH)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ ì‹¤íŒ¨."
              exit 1
            fi
            
            # 4. SSH ì„¸ì…˜ ì¢…ë£Œ
            sleep 5
            echo "Deployment initiated. Disconnecting SSH session successfully."
            exit 0