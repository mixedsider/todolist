# ----------------------------------------------------------
# 4-3. Target Serverì—ì„œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
# ----------------------------------------------------------
- name: Stop, Rename, and Restart Backend Application (via Bastion)
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.DEPLOY_HOST }}
    username: ${{ secrets.DEPLOY_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    port: 22 # Target Server SSH í¬íŠ¸ (ê¸°ë³¸ 22)

    proxy_host: ${{ secrets.BASTION_HOST }}
    proxy_username: ${{ secrets.BASTION_USER }}
    proxy_port: ${{ secrets.BASTION_HOST_PORT }}
    proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

    script: |
      # 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      DB_URL="${{ secrets.DB_URL }}"
      DB_USER="${{ secrets.DB_USERNAME }}"
      DB_PASS="${{ secrets.DB_PASSWORD }}"
      DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
      
      # ë°°í¬ ë””ë ‰í„°ë¦¬ (ì‚¬ìš©ìž í™˜ê²½ì— ë§žê²Œ ìˆ˜ì • í•„ìš”)
      DEPLOY_PATH="/home/${DEPLOY_USER}/backend"
      
      # ðŸ’¡ [ìˆ˜ì • í¬ì¸íŠ¸ 1] GitHub Context ë¬¸ë²•(${{ }})ì„ ì‚¬ìš©í•˜ì—¬ í•´ì‹œ ê°’ì„ ì§ì ‘ ì£¼ìž…
      TARGET_JAR_NAME="backend-${{ github.sha }}.jar"
      FINAL_JAR_PATH="${DEPLOY_PATH}/${TARGET_JAR_NAME}"
      
      echo "Deployment started..."
      echo "Target Jar: $FINAL_JAR_PATH"
      
      # 2. ë°°í¬ ë””ë ‰í„°ë¦¬ë¡œ ì´ë™ ë° ìµœì‹  ì—…ë¡œë“œ íŒŒì¼ í™•ì¸
      cd "$DEPLOY_PATH" || { echo "Deploy path not found"; exit 1; }
      
      # scpë¡œ ì˜¬ë¼ì˜¨ íŒŒì¼ ì¤‘ ê°€ìž¥ ìµœì‹  .jar ì°¾ê¸° (ë°©ê¸ˆ ì˜¬ë¦° íŒŒì¼)
      # 'ls -t'ëŠ” ì‹œê°„ìˆœ ì •ë ¬, 'head -n 1'ì€ ê°€ìž¥ ìƒìœ„ 1ê°œ
      NEW_JAR=$(ls -t *.jar | head -n 1)
      
      if [ -z "$NEW_JAR" ]; then
        echo "âŒ Error: No JAR file found in $DEPLOY_PATH"
        exit 1
      fi
      
      echo "Found new JAR: $NEW_JAR"
      
      # 3. íŒŒì¼ëª… ë³€ê²½ (backend-0.0.1.jar -> backend-{hash}.jar)
      # íŒŒì¼ì´ ë‹¤ë¥¼ ê²½ìš°ì—ë§Œ ë³µì‚¬/ì´ë™
      if [ "$NEW_JAR" != "$TARGET_JAR_NAME" ]; then
        cp "$NEW_JAR" "$TARGET_JAR_NAME"
        echo "Copied $NEW_JAR to $TARGET_JAR_NAME"
      fi
      
      # 4. ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
      CURRENT_PID=$(ps -ef | grep java | grep "$DEPLOY_PATH" | grep -v grep | awk '{print $2}')
      
      if [ -n "$CURRENT_PID" ]; then
        echo "Stopping old process with PID: $CURRENT_PID"
        kill -9 "$CURRENT_PID"
        sleep 5
      else
        echo "No active Java process found."
      fi
      
      # 5. ìƒˆ JAR ì‹¤í–‰
      if [ ! -f "$FINAL_JAR_PATH" ]; then
        echo "âŒ Error: Target JAR file ($FINAL_JAR_PATH) not found!"
        exit 1
      fi
      
      echo "Starting application..."
      chmod 744 "$FINAL_JAR_PATH"
      
      # ðŸ’¡ [ìˆ˜ì • í¬ì¸íŠ¸ 2] ì‹¤í–‰ ì‹œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš© ë° nohup ì²˜ë¦¬
      nohup java \
        -Dspring.datasource.url="$DB_URL" \
        -Dspring.datasource.username="$DB_USER" \
        -Dspring.datasource.password="$DB_PASS" \
        -jar "$FINAL_JAR_PATH" \
        > "$DEPLOY_PATH/app.log" 2>&1 &
      
      echo "Deployment command executed. Log path: $DEPLOY_PATH/app.log"
      exit 0
