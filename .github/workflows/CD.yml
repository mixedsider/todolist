name: CD - Build and Deploy

# main 브랜치에 코드가 푸시될 때 워크플로우 실행
on:
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: DEPLOY # 배포 환경 지정 (선택 사항)

    steps:
      # 1. 최신 커밋 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # 2. 백엔드(Java/Spring Boot) 빌드 설정 (Working Directory: backend)
      # ==========================================================
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/build.gradle*', 'backend/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant Execute Permission for gradlew
        run: chmod +x ./backend/gradlew

      # 백엔드 빌드 실행
      - name: Build Backend JAR
        working-directory: ./backend
        run: ./gradlew bootJar

      # ==========================================================
      # 3. 프론트엔드(Node.js) 빌드 설정 (Working Directory: frontend)
      # ==========================================================
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      # 프론트엔드 빌드 실행
      - name: Build Frontend DIST
        working-directory: ./frontend
        run: npm run build

      # ==========================================================
      # 4. 배포 (SSH 연결 및 파일 전송)
      # ==========================================================

      # SSH 에이전트 설정 및 키 로드
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-1. Frontend DIST 파일 서버로 직접 전송 (BASTION_HOST = Frontend Deploy Target)
      # ----------------------------------------------------------
      - name: Transfer Frontend DIST to Bastion/Frontend Server
        uses: appleboy/scp-action@v0.1.7
        with:
          # 프론트엔드는 Bastion 호스트에 직접 배포
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      # ----------------------------------------------------------
      # 4-2. Backend JAR 파일 Target Server로 Proxy를 통해 전송
      # ----------------------------------------------------------
      - name: Transfer Backend JAR to Target Server (via Bastion)
        uses: appleboy/scp-action@v0.1.7
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/build/libs/*.jar"
          target: "~/backend"
          strip_components: 3

          # Bastion Host 설정 (ProxyCommand 역할)
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}

      # ----------------------------------------------------------
      # 4-3. Target Server에서 서비스 재시작 (Proxy를 통해 SSH 명령 실행)
      # ----------------------------------------------------------
      - name: Stop, Rename, and Restart Backend Application (via Bastion)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # Bastion Host 설정
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}

          # 메모리 부족 회피를 위한 exit 0 로직이 포함된 스크립트
          script: |
            # 1. 환경 변수 정의
            # GitHub Vars에서 DB_URL, DB_PORT를 가져오고 Secrets에서 DB_USERNAME, DB_PASSWORD를 가져옵니다.
            DB_URL="${{ secrets.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"

            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            JAR_NAME="backend.jar"

            # 기존 프로세스 종료
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            fi

            # 새로운 JAR 파일 교체
            LATEST_JAR=$(ls -t ${DEPLOY_PATH}/*.jar | grep -v "${JAR_NAME}" | head -n 1)
            if [ -f "$LATEST_JAR" ]; then
              echo "Found new JAR: $LATEST_JAR"
              rm -f ${DEPLOY_PATH}/${JAR_NAME}
              mv $LATEST_JAR ${DEPLOY_PATH}/${JAR_NAME}
              echo "New application file deployed: ${DEPLOY_PATH}/${JAR_NAME}"
            fi

            # 3. 애플리케이션 실행 및 세션 분리 (Status 137 오류 방지)
            echo "Starting application with properties..."
            # nohup을 사용하여 백그라운드에서 실행하고, 환경 변수를 인라인으로 전달
            nohup java -jar \
              -DB_URL=$DB_URL \
              -DB_USERNAME=$DB_USER \
              -DB_PASSWORD=$DB_PASS \
              ${DEPLOY_PATH}/${JAR_NAME} \
              > ${DEPLOY_PATH}/app.log 2>&1 &
            
            # SSH 세션을 성공적으로 종료하여 워크플로우 상태를 OK로 만듭니다.
            echo "Deployment initiated. Disconnecting SSH session."
            exit 0