name: CD - Deploy to Remote Server (Dependent on CI)

on:
  workflow_run:
    # 1. CI ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ìœ¼ë¡œ ì„¤ì • (ci.yml íŒŒì¼ì˜ name í•„ë“œì™€ ì¼ì¹˜í•´ì•¼ í•¨)
    workflows: ["CI - Test & Report"]
    # 2. CI ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œ(completed)ë˜ì—ˆì„ ë•Œë§Œ íŠ¸ë¦¬ê±°
    types: [completed]
    # 3. main ë¸Œëžœì¹˜ì— ëŒ€í•´ì„œë§Œ ë°°í¬
    branches: [main]

jobs:
  # CD Jobì€ CI Jobì˜ ì„±ê³µ ì—¬ë¶€ì— ë”°ë¼ ì¡°ê±´ë¶€ ì‹¤í–‰ë©ë‹ˆë‹¤.
  deploy:
    # CI ì›Œí¬í”Œë¡œìš°ì˜ ê²°ë¡ (conclusion)ì´ 'success'ì¼ ë•Œë§Œ ì‹¤í–‰
    #if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1. ì›ê²© CI ì›Œí¬í”Œë¡œìš°ì˜ ì»¤ë°‹ìœ¼ë¡œ ì²´í¬ì•„ì›ƒ (CIê°€ ì‹¤í–‰ëœ ì‹œì ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜´)
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # 2. Artifacts ë‹¤ìš´ë¡œë“œ (CIì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°)
      # ë‹¤ìš´ë¡œë“œí•  ì›Œí¬í”Œë¡œìš° IDë¥¼ ì°¸ì¡°í•´ì•¼ í•©ë‹ˆë‹¤.
      - name: Get CI Artifacts ID
        uses: actions/github-script@v7
        id: get-artifact
        with:
          script: |
            // CI ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„í‹°íŒ©íŠ¸ IDë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const runId = context.payload.workflow_run.id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            // ë‹¤ìš´ë¡œë“œí•  ì•„í‹°íŒ©íŠ¸ ëª©ë¡ì„ ì°¾ìŠµë‹ˆë‹¤.
            core.setOutput('run_id', runId);
            core.setOutput('backend_id', artifacts.data.artifacts.find(a => a.name === 'deploy-backend-jar').id);
            core.setOutput('frontend_id', artifacts.data.artifacts.find(a => a.name === 'deploy-frontend-dist').id);

      - name: Download Backend JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-backend-jar
          path: ./artifacts/backend/

      - name: Download Frontend DIST Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-frontend-dist
          path: ./artifacts/frontend/

      # --- (ì´í•˜ SSH ì„¤ì • ë° ë°°í¬ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼) ---
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- íŒŒì¼ ì „ì†¡ ë° ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘ ---
      - name: Transfer Backend JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "artifacts/backend/*.jar"
          target: "~/backend"
          strip_components: 2

      - name: Transfer Frontend DIST to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "artifacts/frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      - name: Stop, Rename, and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # ðŸš¨ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • ë¶€ë¶„ ðŸš¨
          script: |
            # 1. í™˜ê²½ ë³€ìˆ˜ ì •ì˜
            # ${{ secrets.SECRET_NAME }} ë¬¸ë²•ìœ¼ë¡œ GitHub Secrets ê°’ì„ ì½ì–´ì™€ bash ë³€ìˆ˜ë¡œ ì„ ì–¸í•©ë‹ˆë‹¤.
            DB_URL="${{ vars.DB_URL }}"          # ì¼ë°˜ í™˜ê²½ ë³€ìˆ˜ (vars.)
            DB_USER="${{ secrets.DB_USERNAME }}" # ì‹œí¬ë¦¿ ë³€ìˆ˜ (secrets.)
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DB_PORT="${{ vars.DB_PORT }}"         # ì¼ë°˜ í™˜ê²½ ë³€ìˆ˜ (vars.)
            
            # Spring Bootê°€ ì¸ì‹í•˜ëŠ” í™˜ê²½ ë³€ìˆ˜ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ (ì„ íƒì‚¬í•­, í•˜ì§€ë§Œ ê¶Œìž¥)
            # DB_URL, DB_USERNAME, DB_PASSWORD, DB_PORT ëŠ” ì˜ˆì‹œìž…ë‹ˆë‹¤.
            # Spring Bootì˜ í‘œì¤€ í™˜ê²½ ë³€ìˆ˜ëª…(SPRING_DATASOURCE_URL ë“±)ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ìž…ë‹ˆë‹¤.
            
            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            JAR_NAME="backend.jar"
            
            # (ì¤‘ëžµ: ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ë° íŒŒì¼ êµì²´ ë¡œì§)
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            fi
            
            # ----------------------------------------------------
            # 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ìž¬ì‹¤í–‰ ì‹œ í™˜ê²½ ë³€ìˆ˜/ì‹œìŠ¤í…œ ì†ì„± ì „ë‹¬ (ê°€ìž¥ ì¤‘ìš”í•œ ë¶€ë¶„)
            # ----------------------------------------------------
            
            # ë°©ë²• 1: -D ì‹œìŠ¤í…œ ì†ì„± ì „ë‹¬ (DB_URLì„ Springì´ ë°”ë¡œ ì½ëŠ”ë‹¤ê³  ê°€ì •)
            echo "Starting application with properties..."
            nohup java -jar \
              -DDB_URL=$DB_URL \
              -DDB_USERNAME=$DB_USER \
              -DDB_PASSWORD=$DB_PASS \
              -DDB_PORT=$DB_PORT \
              ${DEPLOY_PATH}/${JAR_NAME} \
              > ${DEPLOY_PATH}/app.log 2>&1 &
            
            # --- OR ---
            
            # ë°©ë²• 2: Export í™˜ê²½ ë³€ìˆ˜ ì „ë‹¬ (Spring Bootì˜ í‘œì¤€ í™˜ê²½ ë³€ìˆ˜ëª… ì‚¬ìš© ì‹œ)
            # export SPRING_DATASOURCE_URL="jdbc:postgresql://$DB_URL:$DB_PORT/..."
            # nohup java -jar ${DEPLOY_PATH}/${JAR_NAME} > ${DEPLOY_PATH}/app.log 2>&1 &
            
            echo "Deployment and restart complete."