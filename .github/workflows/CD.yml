name: CD - Build and Deploy

# main 브랜치에 코드가 푸시될 때 워크플로우 실행
on:
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: DEPLOY # 배포 환경 지정 (선택 사항)

    steps:
      # 1. 최신 커밋 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # ==========================================================
      # 2. 백엔드(Java/Spring Boot) 빌드 설정 (Working Directory: backend)
      # ==========================================================
      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/build.gradle*', 'backend/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant Execute Permission for gradlew
        run: chmod +x ./backend/gradlew

      # 백엔드 빌드 실행
      - name: Build Backend JAR
        working-directory: ./backend
        run: ./gradlew bootJar

      # ==========================================================
      # 3. 프론트엔드(Node.js) 빌드 설정 (Working Directory: frontend)
      # ==========================================================
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      # 프론트엔드 빌드 실행
      - name: Build Frontend DIST
        working-directory: ./frontend
        run: npm run build

      # ==========================================================
      # 4. 배포 (SSH 연결 및 파일 전송)
      # ==========================================================

      # SSH 에이전트 설정 및 키 로드
      - name: Set up SSH Agent and Keys
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-1. Frontend DIST 파일 서버로 직접 전송 (BASTION_HOST = Frontend Deploy Target)
      # ----------------------------------------------------------
      - name: Transfer Frontend DIST to Bastion/Frontend Server
        uses: appleboy/scp-action@v0.1.7
        with:
          # 프론트엔드는 Bastion 호스트에 직접 배포
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.BASTION_HOST_PORT }}
          source: "frontend/dist/*"
          target: "~/frontend"
          strip_components: 2

      # ----------------------------------------------------------
      # 4-2. Backend JAR 파일 Target Server로 Proxy를 통해 전송
      # ----------------------------------------------------------
      - name: Transfer Backend JAR to Target Server (via Bastion)
        uses: appleboy/scp-action@v0.1.7
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/build/libs/*.jar"
          target: "~/backend/backend.jar.new"
          strip_components: 3

          # Bastion Host 설정 (ProxyCommand 역할)
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ----------------------------------------------------------
      # 4-3. Target Server에서 서비스 재시작 (Proxy를 통해 SSH 명령 실행)
      # ----------------------------------------------------------
      - name: Stop, Rename, and Restart Backend Application (via Bastion)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Target Server 접속 정보 (내부 IP)
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}

          # Bastion Host 설정
          proxy_host: ${{ secrets.BASTION_HOST }}
          proxy_username: ${{ secrets.BASTION_USER }}
          proxy_port: ${{ secrets.BASTION_HOST_PORT }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}

          script: |
            # 1. 환경 변수 정의
            DB_URL="${{ secrets.DB_URL }}"
            DB_USER="${{ secrets.DB_USERNAME }}"
            DB_PASS="${{ secrets.DB_PASSWORD }}"
            DEPLOY_PATH="/home/${{ secrets.DEPLOY_USER }}/backend"
            JAR_NAME="backend.jar"
            NEW_JAR_NAME="backend.jar.new" 
            NEW_JAR_PATH="${DEPLOY_PATH}/${NEW_JAR_NAME}"
            FINAL_JAR_PATH="${DEPLOY_PATH}/${JAR_NAME}"

            # 2. 기존 프로세스 종료 (유지)
            CURRENT_PID=$(ps -ef | grep java | grep "${JAR_NAME}" | awk '{print $2}')
            if [ -n "$CURRENT_PID" ]; then
              echo "Stopping process with PID: $CURRENT_PID"; kill -9 $CURRENT_PID; sleep 5;
            fi

            # 3. 새로운 JAR 파일 확인 및 교체 (단순화 로직)
            if [ -f "$NEW_JAR_PATH" ]; then
              echo "✅ 새로 전송된 파일 ($NEW_JAR_PATH) 확인."
            
              # 기존 backend.jar 파일 삭제
              if [ -f "$FINAL_JAR_PATH" ]; then
                rm -f "$FINAL_JAR_PATH"
                echo "기존 ${JAR_NAME} 파일 제거 완료."
              fi
            
              # 임시 파일 이름 변경 (mv)
              mv "$NEW_JAR_PATH" "$FINAL_JAR_PATH"
            
              # 이름 변경 성공 여부 확인 🚨 (요청하신 필수 로직)
              if [ $? -eq 0 ]; then
                echo "✅ 파일 이름 변경 성공: $FINAL_JAR_PATH"
              else
                echo "❌ 파일 이름 변경 실패. mv 명령을 확인하십시오."
                exit 1 # 이름 변경 실패 시 워크플로우 중단
              fi
            else
              echo "❌ 새로운 임시 JAR 파일 ($NEW_JAR_PATH)을 찾을 수 없습니다. 전송 단계 확인 필요."
              exit 1
            fi

            # 4. 애플리케이션 실행 및 세션 분리
            echo "Starting application with properties..."
            # Spring Boot 표준 속성(Dspring.datasource.*)으로 DB 정보를 전달
            nohup java -jar \
              -Dspring.datasource.url=$DB_URL \
              -Dspring.datasource.username=$DB_USER \
              -Dspring.datasource.password=$DB_PASS \
              "$FINAL_JAR_PATH" \
              > ${DEPLOY_PATH}/app.log 2>&1 &
            
            # 백그라운드 프로세스 시작 확인을 위한 짧은 대기 후 SSH 세션 종료
            sleep 2
            
            # SSH 세션을 성공적으로 종료하여 워크플로우 상태를 OK로 만듭니다. 🚨 (요청하신 필수 로직)
            echo "Deployment initiated. Disconnecting SSH session."
            exit 0